<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grades - Student Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <script>
        // CRITICAL: Check localStorage support and protocol
        window.addEventListener('load', () => {
            console.log('üåê Protocol:', window.location.protocol);
            console.log('üåê Host:', window.location.host);
            console.log('üåê Full URL:', window.location.href);
            
            if (window.location.protocol === 'file:') {
                console.warn('‚ö†Ô∏è WARNING: Using file:// protocol! localStorage may not persist!');
                console.warn('‚ö†Ô∏è Please use a local server (see README_STORAGE.md)');
                alert('‚ö†Ô∏è WARNING: You are using file:// protocol!\n\nlocalStorage may not work properly.\n\nPlease use a local server:\n1. Open Terminal\n2. cd to project folder\n3. Run: python3 -m http.server 8000\n4. Open: http://localhost:8000');
            }
            
            // Test localStorage
            try {
                localStorage.setItem('__test__', 'test');
                const test = localStorage.getItem('__test__');
                if (test === 'test') {
                    localStorage.removeItem('__test__');
                    console.log('‚úÖ localStorage is working!');
                } else {
                    console.error('‚ùå localStorage test failed!');
                }
            } catch (e) {
                console.error('‚ùå localStorage error:', e);
                alert('‚ùå localStorage is disabled or not available!\n\n' + e.message);
            }
        });
    </script>
</head>
<body>
    <button class="mobile-menu-toggle" onclick="toggleSidebar()">‚ò∞</button>

    <div class="dashboard-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo-full">EMSISystem</div>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="index.html"><span class="nav-icon">üè†</span><span class="nav-text">Dashboard</span></a></li>
                    <li><a href="results.html"><span class="nav-icon">üìà</span><span class="nav-text">Result</span></a></li>
                    <li><a href="grades.html" class="active"><span class="nav-icon">üìù</span><span class="nav-text">Grade</span></a></li>
                    <li><a href="students.html"><span class="nav-icon">üë•</span><span class="nav-text">Student</span></a></li>
                    <li><a href="modules.html"><span class="nav-icon">üìö</span><span class="nav-text">Module</span></a></li>
                    <li><a href="profile.html"><span class="nav-icon">‚öôÔ∏è</span><span class="nav-text">Profile</span></a></li>
                </ul>
            </nav>
            <div class="sidebar-footer">
                <div class="sidebar-user-info">
                    <div class="sidebar-user-role">Admin</div>
                    <div class="sidebar-user-role">Teacher</div>
                </div>
                <button class="sidebar-logout-btn" onclick="logoutUser()">Logout</button>
                <div class="theme-toggle-sidebar" style="margin-top: var(--spacing-md);">
                    <button class="theme-btn active" id="darkThemeBtn" onclick="setTheme('dark')" title="Dark mode">üåô</button>
                    <button class="theme-btn" id="lightThemeBtn" onclick="setTheme('light')" title="Light mode">‚òÄÔ∏è</button>
                </div>
            </div>
        </aside>

        <main class="main-content">
            <div class="top-navbar-simple">
                <div class="navbar-logo">EMSISystem</div>
                <h1>Grades Assignment</h1>
                <div class="user-badge" id="userBadge">Teacher</div>
            </div>

            <div class="content-area">
                <div class="card">
                    <div class="alert alert-info">
                        <strong>üìù Instructions for Teachers:</strong> 
                        <ul style="margin: 8px 0 0 20px; padding: 0;">
                            <li><strong>Enter Grades:</strong> Type a number between 0 and 20 in the "Grade" field for each student and module.</li>
                            <li><strong>Enter Absences:</strong> Type the number of absences in the "Absences" field (0 or positive number).</li>
                            <li><strong>Auto-Save:</strong> Data is saved automatically when you click outside the input field or press Enter.</li>
                            <li><strong>Color Coding:</strong> Grades are color-coded (Green ‚â•16, Blue ‚â•14, Yellow ‚â•12, Light Blue ‚â•10, Red &lt;10).</li>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <h2>Grades & Absences Table</h2>
                        <div id="tableStatus" style="font-size: 13px; color: var(--text-secondary);">
                            Loading table...
                        </div>
                    </div>
                    <div id="gradesTableContainer" style="min-height: 200px;"></div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script src="js/grades.js"></script>
    <script>
        /**
         * ============================================
         * GRADES PAGE - JavaScript Initialization
         * ============================================
         */
        
        // Protect page - only teachers can access
        protectPage('teacher');
        
        // Get current user and update UI
        const user = getCurrentUser();
        if (user) {
            document.getElementById('userBadge').textContent = user.role === 'teacher' ? 'Teacher' : 'Student';
        }
        
        // Initialize theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        setTheme(savedTheme);
        
        function setTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
                document.getElementById('darkThemeBtn').classList.add('active');
                document.getElementById('lightThemeBtn').classList.remove('active');
            } else {
                document.body.classList.add('light-theme');
                document.body.classList.remove('dark-theme');
                document.getElementById('lightThemeBtn').classList.add('active');
                document.getElementById('darkThemeBtn').classList.remove('active');
            }
            localStorage.setItem('theme', theme);
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }
        
        // Ensure grades table is displayed after page loads
        // Multiple initialization attempts to ensure it works
        function initializeGradesPage() {
            // Check if user is teacher
            const user = getCurrentUser();
            if (!user || user.role !== 'teacher') {
                console.error('Only teachers can access this page');
                return;
            }
            
            // Wait a bit for DOM to be ready
            setTimeout(() => {
                if (typeof displayGradesTable === 'function') {
                    console.log('Displaying grades table...');
                    displayGradesTable();
                } else {
                    console.error('displayGradesTable function not found!');
                }
            }, 100);
        }
        
        // Try multiple times to ensure it loads
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeGradesPage);
        } else {
            initializeGradesPage();
        }
        
        window.addEventListener('load', () => {
            // Test localStorage on load
            if (typeof testLocalStorage === 'function') {
                testLocalStorage();
            }
            initializeGradesPage();
        });
        
        // Also try after a longer delay as backup
        setTimeout(() => {
            const container = document.getElementById('gradesTableContainer');
            if (container && (!container.innerHTML || container.innerHTML.trim() === '')) {
                console.log('üîÑ Backup: Re-initializing grades table...');
                initializeGradesPage();
            }
        }, 500);
    </script>
</body>
</html>
